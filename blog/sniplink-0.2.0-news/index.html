<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Inside SnipLink v0.2.0 - News Page - TehGM's Blog</title><meta name=Description content="SnipLink v0.2.0 released with News page feature. Let's see how it looks under the hood!"><meta property="og:title" content="Inside SnipLink v0.2.0 - News Page"><meta property="og:description" content="SnipLink v0.2.0 released with News page feature. Let's see how it looks under the hood!"><meta property="og:type" content="article"><meta property="og:url" content="https://tehgm.net/blog/sniplink-0.2.0-news/"><meta property="og:image" content="https://tehgm.net/blog/technology/sniplink-0.2.0-news/thumb.png"><meta property="article:published_time" content="2021-09-16T19:43:21+01:00"><meta property="article:modified_time" content="2021-09-16T19:43:21+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tehgm.net/blog/technology/sniplink-0.2.0-news/thumb.png"><meta name=twitter:title content="Inside SnipLink v0.2.0 - News Page"><meta name=twitter:description content="SnipLink v0.2.0 released with News page feature. Let's see how it looks under the hood!"><meta name=application-name content="TehGM"><meta name=apple-mobile-web-app-title content="TehGM"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://tehgm.net/blog/sniplink-0.2.0-news/><link rel=prev href=https://tehgm.net/blog/stalker-anomaly-modpack/><link rel=next href=https://tehgm.net/blog/docker-cheatsheet/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Inside SnipLink v0.2.0 - News Page","inLanguage":"en-gb","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/tehgm.net\/blog\/sniplink-0.2.0-news\/"},"image":["https:\/\/tehgm.net\/img\/tehgm_avatar.png"],"genre":"blog","keywords":"dev, web","wordcount":3759,"url":"https:\/\/tehgm.net\/blog\/sniplink-0.2.0-news\/","datePublished":"2021-09-16T19:43:21+01:00","dateModified":"2021-09-16T19:43:21+01:00","publisher":{"@type":"Organization","name":"TehGM"},"author":{"@type":"Person","name":"TehGM"},"description":"SnipLink v0.2.0 released with News page feature. Let's see how it looks under the hood!"}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=TehGM><span id=id-1 class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/ title=Home>Home </a><a class=menu-item href=/blog/ title=Blog>Blog </a><a class=menu-item href=/blog/imo/ title="Blog: IMO">IMO </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=TehGM><span id=id-2 class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/ title=Home>Home</a><a class=menu-item href=/blog/ title=Blog>Blog</a><a class=menu-item href=/blog/imo/ title="Blog: IMO">IMO</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class="toc-content always-active" id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Inside SnipLink v0.2.0 - News Page</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://tehgm.net title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw"></i>TehGM</a></span>&nbsp;<span class=post-category>included in <a href=/blog/categories/technology/><i class="far fa-folder fa-fw"></i>Technology</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=16.09.2021>16.09.2021</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3759 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;18 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=thumb.png data-srcset="/blog/sniplink-0.2.0-news/thumb.png, thumb.png 1.5x, /blog/sniplink-0.2.0-news/thumb.png 2x" data-sizes=auto alt=/blog/sniplink-0.2.0-news/thumb.png title="Inside SnipLink v0.2.0 - News Page"></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#why-news-page>Why News Page?</a></li><li><a href=#the-technicalities>The Technicalities</a><ul><li><a href=#news-entities>News Entities</a></li><li><a href=#markdown>Markdown</a></li><li><a href=#yaml>YAML</a></li><li><a href=#razor>Razor</a></li><li><a href=#news-provider>News Provider</a></li><li><a href=#displaying-posts>Displaying Posts</a></li></ul></li><li><a href=#what-else>What else?</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></div><div class=content id=content><p>A few days ago I released <a href=https://beta.sniplink.net/news/release-v0.2.0 target=_blank rel="noopener noreffer">SnipLink v0.2.0</a>. The 2 biggest features include News page and Discord Integration. Today I&rsquo;ll talk about the former.</p><p>Warning: Quite code-heavy post. ðŸ˜…</p><h2 id=why-news-page>Why News Page?</h2><p>Long story short&mldr;</p><p>Changelogs are useful for variety of reasons, and I wanted to have a changelog on SnipLink. After some thinking of how to approach it in component-oriented manner (so I it&rsquo;s not all mess!), I realized that publishing content like this using raw HTML, while works, would be insanely tedious - especially since I have this blog to compare with, which uses Hugo and Markdown files. I decided I want to do something similar for SnipLink, too.</p><p>And then I figured &ldquo;since I am doing it markdown way, I can make actual news feature, like many actual products have&rdquo;. And to be honest, that&rsquo;s not a stupid idea - if I can get manageable markdown content files, it makes news page relatively easy.</p><p>And as such, I started developing what effectively is a simple (but powerful!) blog engine inside of my link shortener project.</p><h2 id=the-technicalities>The Technicalities</h2><p>So with introduction done, let&rsquo;s delve into the actual tech&mldr;</p><p>Note: I&rsquo;ll skip some implementation details, cause the idea of this post is to explain the idea, not go deep into every single line of code - not only that would be boring, but also there&rsquo;s tons of code that is not needed to explain that idea, so let&rsquo;s trim it down to specifics.</p><h3 id=news-entities>News Entities</h3><p>First off, I needed some entities to represent the posts. The general idea was to have metadata, which stores&mldr; well, metadata&mldr; and the post itself. This would allow me to skip parsing the contents of the post until it&rsquo;s actually opened, as well cache less in memory unless more is needed.</p><p>These entities changed a lot during the implementation course, but here&rsquo;s what they contain so far:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>class</span> <span class=nc>NewsPostMetadata</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>ID</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>FilePath</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>Title</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>Description</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>ArticleThumbnailURL</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>ListThumbnailURL</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=c1>// using razor engine is expensive. Use only if required.
</span><span class=c1></span>    <span class=k>public</span> <span class=kt>bool</span> <span class=n>UseRazorEngine</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=n>DateTimeOffset</span><span class=p>?</span> <span class=n>Timestamp</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=n>DateTimeOffset</span><span class=p>?</span> <span class=n>ModificationTimestamp</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>Environments</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>

    <span class=k>public</span> <span class=kt>object</span> <span class=k>this</span><span class=p>[</span><span class=kt>string</span> <span class=n>key</span><span class=p>]</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=n>_data</span><span class=p>[</span><span class=n>key</span><span class=p>];</span>

    <span class=k>private</span> <span class=k>readonly</span> <span class=n>IDictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object</span><span class=p>&gt;</span> <span class=n>_data</span><span class=p>;</span>

    <span class=k>public</span> <span class=n>NewsPostMetadata</span><span class=p>(</span><span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>string</span> <span class=n>filepath</span><span class=p>,</span> <span class=n>IDictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object</span><span class=p>&gt;</span> <span class=n>data</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=c1>// parse data here
</span><span class=c1></span>    <span class=p>}</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>class</span> <span class=nc>NewsPost</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>ID</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>ID</span><span class=p>;</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>FilePath</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>FilePath</span><span class=p>;</span>
    <span class=k>public</span> <span class=n>NewsPostMetadata</span> <span class=n>Metadata</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>HtmlContent</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>string</span> <span class=n>MarkdownContent</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

    <span class=k>public</span> <span class=n>NewsPost</span><span class=p>(</span><span class=n>NewsPostMetadata</span> <span class=n>metadata</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>metadata</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>ArgumentNullException</span><span class=p>(</span><span class=n>nameof</span><span class=p>(</span><span class=n>metadata</span><span class=p>));</span>

        <span class=k>this</span><span class=p>.</span><span class=n>Metadata</span> <span class=p>=</span> <span class=n>metadata</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Okay, so some things are self explanatory, but some are less obvious - so let me explain them:</p><ul><li><code>data</code> in <strong>NewsPostMetadata</strong> constructor is the output of YAML parser - read more below!</li><li>Article and List thumbnails are separate, because I noticed that some thumbnails look bad when &ldquo;shrunk&rdquo; on the posts list. But don&rsquo;t worry - the constructor actually checks <code>data</code> for &ldquo;thumbnail&rdquo; and uses it for both, and only then overwrites the specific ones.</li><li><code>UseRazorEngine</code> is a switch to enable or disable <a href=#razor rel>Razor parsing support</a> - as comment says, it can be expensive, so it&rsquo;s enabled only for content that actually needs it.</li><li>Features need testing, and since I am using .md files, they get output to the server. <code>Environments</code> prevents that. News Provider checks this collection - if it&rsquo;s empty, the post is included everywhere, but if it&rsquo;s &ldquo;Beta&rdquo; and &ldquo;Production&rdquo;, only Beta and Production servers will display this post.</li><li>Both <code>HtmlContent</code> and <code>MarkdownContent</code> are settable in <strong>NewsPost</strong> - this is so they can be lazy loaded when needed, and no sooner than that.</li></ul><h3 id=markdown>Markdown</h3><p>The most important step was to get markdown working. I began where every programmer goes the most often - with Google!<br>Very quickly I found a special library <a href=https://github.com/RickStrahl/Westwind.AspNetCore.Markdown target=_blank rel="noopener noreffer">Westwind.AspNetCore.Markdown</a> for ASP.NET Core that does just that - Markdown support. It also offers it quite out of the box. So yeah, that&rsquo;s it, install it, and have a news engine, right?</p><p>Well, no.<br>While this library seems all good, I quickly found that it does just too much &ldquo;out of the box&rdquo; for my liking. For that reason, I&rsquo;d have to configure it a ton to work for my liking. The simpler approach for my use case would be use <a href=https://github.com/xoofx/markdig target=_blank rel="noopener noreffer">Markdig</a> parser (which Westwind.AspNetCore.Markdown used itself, actually), and then build on top of it.</p><p>So, I installed it, and created a really minimalistic service, that simply abstracts the call to Markdig.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>interface</span> <span class=n>IMarkdownProvider</span>
<span class=p>{</span>
    <span class=kt>string</span> <span class=n>Parse</span><span class=p>(</span><span class=kt>string</span> <span class=n>markdown</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>class</span> <span class=nc>MarkdownProvider</span> <span class=p>:</span> <span class=n>IMarkdownProvider</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=k>readonly</span> <span class=n>MarkdownPipeline</span> <span class=n>_pipeline</span><span class=p>;</span>

    <span class=k>public</span> <span class=n>MarkdownProvider</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_pipeline</span> <span class=p>=</span> <span class=k>new</span> <span class=n>MarkdownPipelineBuilder</span><span class=p>()</span>
            <span class=p>.</span><span class=n>UseAdvancedExtensions</span><span class=p>()</span>
            <span class=p>.</span><span class=n>Build</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=kt>string</span> <span class=n>Parse</span><span class=p>(</span><span class=kt>string</span> <span class=n>markdown</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>Markdown</span><span class=p>.</span><span class=n>ToHtml</span><span class=p>(</span><span class=n>markdown</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>_pipeline</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=yaml>YAML</h3><p>Markdown is great for post body, but news need the metadata, as well. Just like with Hugo, this is where YAML comes in.</p><p>YAML support is actually really similar to Markdown support. I found a nice working library called <a href=https://github.com/aaubry/YamlDotNet target=_blank rel="noopener noreffer">YamlDotNet</a> - and like with Markdown, I created a minimal service to abstract it:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>interface</span> <span class=n>IYamlProvider</span>
<span class=p>{</span>
    <span class=n>T</span> <span class=n>Parse</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=kt>string</span> <span class=n>yaml</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>class</span> <span class=nc>YamlProvider</span> <span class=p>:</span> <span class=n>IYamlProvider</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=k>readonly</span> <span class=n>IDeserializer</span> <span class=n>_deserializer</span><span class=p>;</span>

    <span class=k>public</span> <span class=n>YamlProvider</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_deserializer</span> <span class=p>=</span> <span class=k>new</span> <span class=n>DeserializerBuilder</span><span class=p>()</span>
            <span class=p>.</span><span class=n>WithNamingConvention</span><span class=p>(</span><span class=n>CamelCaseNamingConvention</span><span class=p>.</span><span class=n>Instance</span><span class=p>)</span>
            <span class=p>.</span><span class=n>Build</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=n>T</span> <span class=n>Parse</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=kt>string</span> <span class=n>yaml</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=n>_deserializer</span><span class=p>.</span><span class=n>Deserialize</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=n>yaml</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h3 id=razor>Razor</h3><p>One thing I really like with ASP.NET Core Razor Pages is how seemlessly I can use C# within my page code. For that reason I wanted to have that for my News page as well.</p><p>To achieve this&mldr; well, you know the drill already - found and installed a library (<a href=https://github.com/Antaris/RazorEngine target=_blank rel="noopener noreffer">RazorEngine</a> in this case) and created a service class:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>interface</span> <span class=n>IRazorProvider</span>
<span class=p>{</span>
    <span class=kt>string</span> <span class=n>Render</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>string</span> <span class=n>content</span><span class=p>,</span> <span class=n>T</span> <span class=n>model</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>class</span> <span class=nc>RazorProvider</span> <span class=p>:</span> <span class=n>IRazorProvider</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=k>readonly</span> <span class=n>IRazorEngineService</span> <span class=n>_razor</span><span class=p>;</span>

    <span class=k>public</span> <span class=n>RazorProvider</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=n>TemplateServiceConfiguration</span> <span class=n>config</span> <span class=p>=</span> <span class=k>new</span> <span class=n>TemplateServiceConfiguration</span><span class=p>();</span>
        <span class=n>config</span><span class=p>.</span><span class=n>Language</span> <span class=p>=</span> <span class=n>Language</span><span class=p>.</span><span class=n>CSharp</span><span class=p>;</span>
        <span class=n>config</span><span class=p>.</span><span class=n>EncodedStringFactory</span> <span class=p>=</span> <span class=k>new</span> <span class=n>HtmlEncodedStringFactory</span><span class=p>();</span>

        <span class=k>this</span><span class=p>.</span><span class=n>_razor</span> <span class=p>=</span> <span class=n>RazorEngineService</span><span class=p>.</span><span class=n>Create</span><span class=p>(</span><span class=n>config</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=kt>string</span> <span class=n>Render</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>string</span> <span class=n>content</span><span class=p>,</span> <span class=n>T</span> <span class=n>model</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>model</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>_razor</span><span class=p>.</span><span class=n>RunCompile</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=n>id</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=k>null</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
        <span class=k>else</span>
            <span class=k>return</span> <span class=n>_razor</span><span class=p>.</span><span class=n>RunCompile</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=n>id</span><span class=p>,</span> <span class=k>typeof</span><span class=p>(</span><span class=n>T</span><span class=p>),</span> <span class=n>model</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>RazorProviderExtensions</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>static</span> <span class=kt>string</span> <span class=n>Render</span><span class=p>(</span><span class=k>this</span> <span class=n>IRazorProvider</span> <span class=n>provider</span><span class=p>,</span> <span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>string</span> <span class=n>content</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>provider</span><span class=p>.</span><span class=n>Render</span><span class=p>&lt;</span><span class=kt>object</span><span class=p>&gt;(</span><span class=n>id</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=k>null</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw"></i>Warning<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content><p>An important note here - enabling Razor engine for posts is not only expensive (since why I added a <a href=#news-entities rel>switch</a> so posts requiring it can opt-in), it can also be dangerous, as it basically allows posts to execute any C# code within your web application - eeep!</p><p>For SnipLink I am the only author, so it&rsquo;s fine. But if you want to build something where users can post their own content, you really <em><strong>SHOULD NOT</strong></em> add this.</p></div></div></div><h3 id=news-provider>News Provider</h3><p>Now time for the beast that glues all the pieces together. News Provider is responsible for loading all the files, splitting the contents, calling the other components, caching and finally returning the posts. That&rsquo;s a lot, so let&rsquo;s break it down into separate steps.</p><h5 id=finding-files>Finding Files</h5><p>The idea behind deciding what files to load is was similar to Hugo - post can be either a <code>.md</code> file in <code>/news/</code> directory, or a folder that contains <code>index.md</code> and other optional files (such as images). Then, either the file name (for the former) or folder name (for the latter) will be considered a post ID - the one you see in the URL.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>private</span> <span class=k>async</span> <span class=n>Task</span> <span class=n>LoadAllPostsMetadataAsync</span><span class=p>()</span>
<span class=p>{</span>
    <span class=c1>// skip loading anything if already loaded
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_allPostsMetadata</span> <span class=p>!=</span> <span class=k>null</span><span class=p>)</span>
        <span class=k>return</span><span class=p>;</span>

    <span class=c1>// load paths of valid files and folders
</span><span class=c1></span>    <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>files</span> <span class=p>=</span> <span class=n>Directory</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>NewsFolderPath</span><span class=p>,</span> <span class=s>&#34;*.md&#34;</span><span class=p>,</span> <span class=n>SearchOption</span><span class=p>.</span><span class=n>TopDirectoryOnly</span><span class=p>);</span>
    <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>folders</span> <span class=p>=</span> <span class=n>Directory</span><span class=p>.</span><span class=n>GetDirectories</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>NewsFolderPath</span><span class=p>,</span> <span class=s>&#34;*&#34;</span><span class=p>,</span> <span class=n>SearchOption</span><span class=p>.</span><span class=n>TopDirectoryOnly</span><span class=p>)</span>
        <span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>f</span> <span class=p>=&gt;</span> <span class=n>File</span><span class=p>.</span><span class=n>Exists</span><span class=p>(</span><span class=n>GetFilePathForFolder</span><span class=p>(</span><span class=n>f</span><span class=p>)));</span>
    <span class=k>this</span><span class=p>.</span><span class=n>_allPostsMetadata</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Dictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=n>NewsPostMetadata</span><span class=p>&gt;(</span><span class=n>files</span><span class=p>.</span><span class=n>Count</span><span class=p>()</span> <span class=p>+</span> <span class=n>folders</span><span class=p>.</span><span class=n>Count</span><span class=p>(),</span> <span class=n>StringComparer</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>);</span>
    
    <span class=c1>// files use their name as ID
</span><span class=c1></span>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>string</span> <span class=n>f</span> <span class=k>in</span> <span class=n>files</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=kt>string</span> <span class=n>id</span> <span class=p>=</span> <span class=n>Path</span><span class=p>.</span><span class=n>GetFileNameWithoutExtension</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
        <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>LoadPostMetadataAsync</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>f</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// folders use their name as ID, and index.md as actual data file
</span><span class=c1></span>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>string</span> <span class=n>f</span> <span class=k>in</span> <span class=n>folders</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=kt>string</span> <span class=n>id</span> <span class=p>=</span> <span class=n>Path</span><span class=p>.</span><span class=n>GetFileName</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
        <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>LoadPostMetadataAsync</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>GetFilePathForFolder</span><span class=p>(</span><span class=n>f</span><span class=p>)).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>And, class methods used by snippet above:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>private</span> <span class=kt>string</span> <span class=n>GetFilePathForFolder</span><span class=p>(</span><span class=kt>string</span> <span class=n>folderPath</span><span class=p>)</span>
    <span class=p>=&gt;</span> <span class=s>$&#34;{folderPath}/index.md&#34;</span><span class=p>;</span>

<span class=k>private</span> <span class=kt>string</span> <span class=n>NewsFolderPath</span>
    <span class=p>=&gt;</span> <span class=n>Path</span><span class=p>.</span><span class=n>Combine</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_environment</span><span class=p>.</span><span class=n>WebRootPath</span><span class=p>,</span> <span class=s>&#34;news&#34;</span><span class=p>);</span>
</code></pre></td></tr></table></div></div><p>So, as you can see, there&rsquo;s no magic going on there. Just a few clever but simple IO operations. Let&rsquo;s go to the next step.</p><h5 id=loading-files>Loading Files</h5><p>You can notice a call to <code>LoadPostMetadataAsync</code> in the snippets above. This is the method that deals with reading the post file and parsing metadata. Let&rsquo;s cover the first step.</p><p>Just like previous step, this one is nothing special, either. Merely some everyday IO code.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>async</span> <span class=n>Task</span> <span class=n>LoadPostMetadataAsync</span><span class=p>(</span><span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>string</span> <span class=n>filePath</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>string</span> <span class=n>postData</span> <span class=p>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>LoadPostFileAsync</span><span class=p>(</span><span class=n>filePath</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
    <span class=c1>// other code (covered later)
</span><span class=c1></span><span class=p>}</span>

<span class=k>private</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>LoadPostFileAsync</span><span class=p>(</span><span class=kt>string</span> <span class=n>path</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>if</span> <span class=p>(!</span><span class=n>File</span><span class=p>.</span><span class=n>Exists</span><span class=p>(</span><span class=n>path</span><span class=p>))</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>FileNotFoundException</span><span class=p>(</span><span class=s>&#34;Specified news post file not found&#34;</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
    <span class=k>using</span> <span class=nn>FileStream</span> <span class=n>stream</span> <span class=p>=</span> <span class=n>File</span><span class=p>.</span><span class=n>Open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>FileMode</span><span class=p>.</span><span class=n>Open</span><span class=p>,</span> <span class=n>FileAccess</span><span class=p>.</span><span class=n>Read</span><span class=p>,</span> <span class=n>FileShare</span><span class=p>.</span><span class=n>Read</span><span class=p>);</span>
    <span class=k>using</span> <span class=nn>StreamReader</span> <span class=n>reader</span> <span class=p>=</span> <span class=k>new</span> <span class=n>StreamReader</span><span class=p>(</span><span class=n>stream</span><span class=p>);</span>
    <span class=kt>string</span> <span class=n>result</span> <span class=p>=</span> <span class=k>await</span> <span class=n>reader</span><span class=p>.</span><span class=n>ReadToEndAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>result</span><span class=p>))</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidDataException</span><span class=p>(</span><span class=s>$&#34;Null data loaded for news post {path}&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h5 id=loading-metadata>Loading Metadata</h5><p>Now to the first actually interesting part - parsing our YAML metadata.</p><p>There are a few things we need to establish:</p><ul><li>YAML starts and ends with <code>---</code> - in code, I named the variable <code>yamlSeparator</code> cause I am bad at naming.</li><li>YAML data is effectively a dictionary, with string keys and anything values - so we&rsquo;ll use just that.</li><li>Every post needs yaml block, and title and timestamp inside, otherwise it&rsquo;s considered invalid.</li><li>Loaded metadata is cached forever, so it can be easily reaused by the application.</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>private</span> <span class=k>const</span> <span class=kt>string</span> <span class=n>yamlSeparator</span> <span class=p>=</span> <span class=s>&#34;---&#34;</span><span class=p>;</span>

<span class=k>private</span> <span class=k>async</span> <span class=n>Task</span> <span class=n>LoadPostMetadataAsync</span><span class=p>(</span><span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>string</span> <span class=n>filePath</span><span class=p>)</span>
<span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=n>_log</span><span class=p>.</span><span class=n>LogTrace</span><span class=p>(</span><span class=s>&#34;Loading news post metadata from {Path}&#34;</span><span class=p>,</span> <span class=n>filePath</span><span class=p>);</span>
    <span class=kt>string</span> <span class=n>postData</span> <span class=p>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>LoadPostFileAsync</span><span class=p>(</span><span class=n>filePath</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(!</span><span class=n>postData</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=n>yamlSeparator</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>Ordinal</span><span class=p>))</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidDataException</span><span class=p>(</span><span class=s>$&#34;News post {filePath} doesn&#39;t start with a valid YAML metadata block&#34;</span><span class=p>);</span>

    <span class=c1>// parse yaml
</span><span class=c1></span>    <span class=kt>string</span> <span class=n>yamlRaw</span> <span class=p>=</span> <span class=n>postData</span><span class=p>.</span><span class=n>Substring</span><span class=p>(</span><span class=n>yamlSeparator</span><span class=p>.</span><span class=n>Length</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>GetYamlEndIndex</span><span class=p>(</span><span class=n>postData</span><span class=p>,</span> <span class=n>filePath</span><span class=p>)</span> <span class=p>-</span> <span class=n>yamlSeparator</span><span class=p>.</span><span class=n>Length</span><span class=p>).</span><span class=n>Trim</span><span class=p>();</span>
    <span class=c1>// copy to a new dictionary so we can make 
</span><span class=c1></span>    <span class=n>IDictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object</span><span class=p>&gt;</span> <span class=n>data</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Dictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object</span><span class=p>&gt;(</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_yaml</span><span class=p>.</span><span class=n>Parse</span><span class=p>&lt;</span><span class=n>IDictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object</span><span class=p>&gt;&gt;(</span><span class=n>yamlRaw</span><span class=p>),</span> <span class=n>StringComparer</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>);</span>
    <span class=c1>// off-load parsing keys to metadata constructor
</span><span class=c1></span>    <span class=n>NewsPostMetadata</span> <span class=n>metadata</span> <span class=p>=</span> <span class=k>new</span> <span class=n>NewsPostMetadata</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>filePath</span><span class=p>,</span> <span class=n>data</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>metadata</span><span class=p>.</span><span class=n>Title</span><span class=p>)</span> <span class=p>||</span> <span class=n>metadata</span><span class=p>.</span><span class=n>Timestamp</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>using</span> <span class=nn>IDisposable</span> <span class=n>logScope</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>_log</span><span class=p>.</span><span class=n>BeginScope</span><span class=p>(</span><span class=k>new</span> <span class=n>Dictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object</span><span class=p>&gt;</span>
            <span class=p>{</span>
                <span class=p>{</span> <span class=s>&#34;yaml&#34;</span><span class=p>,</span> <span class=n>yamlRaw</span> <span class=p>},</span>
                <span class=p>{</span> <span class=s>&#34;Post.ID&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=p>.</span><span class=n>ID</span> <span class=p>},</span>
                <span class=p>{</span> <span class=s>&#34;Post.Title&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=p>.</span><span class=n>Title</span> <span class=p>},</span>
                <span class=p>{</span> <span class=s>&#34;Post.Timestamp&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=p>.</span><span class=n>Timestamp</span> <span class=p>},</span>
                <span class=p>{</span> <span class=s>&#34;Post.UseRazorEngine&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=p>.</span><span class=n>UseRazorEngine</span> <span class=p>}</span>
            <span class=p>});</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_log</span><span class=p>.</span><span class=n>LogError</span><span class=p>(</span><span class=s>&#34;News post {ID} has malformed YAML metadata block: needs both title and timestamp&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=p>.</span><span class=n>ID</span><span class=p>);</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// add to cache - only cache if can be shown in current environment
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>metadata</span><span class=p>.</span><span class=n>ShowInEnvironment</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_environment</span><span class=p>))</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_allPostsMetadata</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>metadata</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>private</span> <span class=kt>int</span> <span class=n>GetYamlEndIndex</span><span class=p>(</span><span class=kt>string</span> <span class=n>postData</span><span class=p>,</span> <span class=kt>string</span> <span class=n>path</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>yamlEndIndex</span> <span class=p>=</span> <span class=n>postData</span><span class=p>.</span><span class=n>IndexOf</span><span class=p>(</span><span class=n>yamlSeparator</span><span class=p>,</span> <span class=n>yamlSeparator</span><span class=p>.</span><span class=n>Length</span><span class=p>,</span> <span class=n>StringComparison</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>yamlEndIndex</span> <span class=p>&lt;</span> <span class=n>yamlSeparator</span><span class=p>.</span><span class=n>Length</span><span class=p>)</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidDataException</span><span class=p>(</span><span class=s>$&#34;News post {path} has malformed YAML metadata block&#34;</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>yamlEndIndex</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>What&rsquo;s worth noting is the <code>ShowInEnvironment</code> method - that method is in the metadata class itself, and simply determines if the post should appear in given environment (Development, Beta, Production etc).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=kt>bool</span> <span class=n>ShowInEnvironment</span><span class=p>(</span><span class=n>IHostEnvironment</span> <span class=n>env</span><span class=p>)</span>
<span class=p>{</span>
    <span class=c1>// environment not specified == simply available as-is
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>Environments</span><span class=p>?.</span><span class=n>Any</span><span class=p>()</span> <span class=p>!=</span> <span class=k>true</span><span class=p>)</span>
        <span class=k>return</span> <span class=k>true</span><span class=p>;</span>

    <span class=c1>// check if should be shown in current env
</span><span class=c1></span>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>string</span> <span class=n>allowedEnvironment</span> <span class=k>in</span> <span class=k>this</span><span class=p>.</span><span class=n>Environments</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>env</span><span class=p>.</span><span class=n>IsEnvironment</span><span class=p>(</span><span class=n>allowedEnvironment</span><span class=p>))</span>
            <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>More interesting, but still not that hard, eh? Let&rsquo;s go to the next step!</p><h5 id=caching>Caching</h5><p>So when we load metadata, we cache it, as we can see in the snippet above. We also cache the loaded <code>NewsPost</code> later. But how do we achieve it?</p><p>Caching of metadata is simple. Because for now I have small amount of posts, I can afford to cache it for the app&rsquo;s lifetime. And for that, something as simple as a dictionary is more than enough - and we can actually see it as we are <a href=#finding-files rel>looking for files</a>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=hl><span class=lnt>5
</span></span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=c1>// ...
</span><span class=c1></span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>files</span> <span class=p>=</span> <span class=n>Directory</span><span class=p>.</span><span class=n>GetFiles</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>NewsFolderPath</span><span class=p>,</span> <span class=s>&#34;*.md&#34;</span><span class=p>,</span> <span class=n>SearchOption</span><span class=p>.</span><span class=n>TopDirectoryOnly</span><span class=p>);</span>
<span class=n>IEnumerable</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>&gt;</span> <span class=n>folders</span> <span class=p>=</span> <span class=n>Directory</span><span class=p>.</span><span class=n>GetDirectories</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>NewsFolderPath</span><span class=p>,</span> <span class=s>&#34;*&#34;</span><span class=p>,</span> <span class=n>SearchOption</span><span class=p>.</span><span class=n>TopDirectoryOnly</span><span class=p>)</span>
    <span class=p>.</span><span class=n>Where</span><span class=p>(</span><span class=n>f</span> <span class=p>=&gt;</span> <span class=n>File</span><span class=p>.</span><span class=n>Exists</span><span class=p>(</span><span class=n>GetFilePathForFolder</span><span class=p>(</span><span class=n>f</span><span class=p>)));</span>
<span class=hl><span class=k>this</span><span class=p>.</span><span class=n>_allPostsMetadata</span> <span class=p>=</span> <span class=k>new</span> <span class=n>Dictionary</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=n>NewsPostMetadata</span><span class=p>&gt;(</span><span class=n>files</span><span class=p>.</span><span class=n>Count</span><span class=p>()</span> <span class=p>+</span> <span class=n>folders</span><span class=p>.</span><span class=n>Count</span><span class=p>(),</span> <span class=n>StringComparer</span><span class=p>.</span><span class=n>OrdinalIgnoreCase</span><span class=p>);</span>
</span><span class=c1>// ...
</span></code></pre></td></tr></table></div></div><p>How about caching the posts themselves? Well, since we want that cache to be cleared at some point, SnipLink uses another solution. I created a relatively simple cache mechanism, that also uses dictionary under the hood, but also checks expiration time and removes expired beings from the memory every time the cache is used in any way.<br>The actual implementation is out of scope for this blog post, but just so you know what&rsquo;s being called in the code below, here&rsquo;s the interface and extension methods:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>interface</span> <span class=n>IEntityCache</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>CachedCount</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=p>}</span>

    <span class=k>void</span> <span class=n>AddOrReplace</span><span class=p>(</span><span class=n>TKey</span> <span class=n>key</span><span class=p>,</span> <span class=n>TEntity</span> <span class=n>entity</span><span class=p>,</span> <span class=n>DateTime</span> <span class=n>expirationTimeUTC</span><span class=p>);</span>
    <span class=kt>bool</span> <span class=n>TryGet</span><span class=p>(</span><span class=n>TKey</span> <span class=n>key</span><span class=p>,</span> <span class=k>out</span> <span class=n>TEntity</span> <span class=n>entity</span><span class=p>);</span>
    <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>TEntity</span><span class=p>&gt;</span> <span class=n>Find</span><span class=p>(</span><span class=n>Func</span><span class=p>&lt;</span><span class=n>CachedEntity</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;,</span> <span class=kt>bool</span><span class=p>&gt;</span> <span class=n>predicate</span><span class=p>);</span>
    <span class=k>void</span> <span class=n>Remove</span><span class=p>(</span><span class=n>TKey</span> <span class=n>key</span><span class=p>);</span>
    <span class=k>void</span> <span class=n>Clear</span><span class=p>();</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>EntityCacheExtensions</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>AddOrReplace</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;(</span><span class=k>this</span> <span class=n>IEntityCache</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;</span> <span class=n>cache</span><span class=p>,</span> <span class=n>TKey</span> <span class=n>key</span><span class=p>,</span> <span class=n>TEntity</span> <span class=n>entity</span><span class=p>,</span> <span class=n>TimeSpan</span> <span class=n>lifetime</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>cache</span><span class=p>.</span><span class=n>AddOrReplace</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>entity</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>.</span><span class=n>UtcNow</span> <span class=p>+</span> <span class=n>lifetime</span><span class=p>);</span>

    <span class=k>public</span> <span class=k>static</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>TEntity</span><span class=p>&gt;</span> <span class=n>Find</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;(</span><span class=k>this</span> <span class=n>IEntityCache</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;</span> <span class=n>cache</span><span class=p>,</span> <span class=n>Func</span><span class=p>&lt;</span><span class=n>TEntity</span><span class=p>,</span> <span class=kt>bool</span><span class=p>&gt;</span> <span class=n>predicate</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>cache</span><span class=p>.</span><span class=n>Find</span><span class=p>((</span><span class=n>i</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=n>predicate</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>Entity</span><span class=p>));</span>

    <span class=k>public</span> <span class=k>static</span> <span class=n>TEntity</span> <span class=n>Get</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;(</span><span class=k>this</span> <span class=n>IEntityCache</span><span class=p>&lt;</span><span class=n>TKey</span><span class=p>,</span> <span class=n>TEntity</span><span class=p>&gt;</span> <span class=n>cache</span><span class=p>,</span> <span class=n>TKey</span> <span class=n>key</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=n>cache</span><span class=p>.</span><span class=n>TryGet</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>out</span> <span class=n>TEntity</span> <span class=n>result</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h5 id=loading-post-body>Loading Post Body</h5><p>Now to the arguably most important part of entire loading process - the post body.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>NewsPost</span><span class=p>&gt;</span> <span class=n>GetNewsPostAsync</span><span class=p>(</span><span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>includeContent</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>id</span> <span class=p>=</span> <span class=n>id</span><span class=p>.</span><span class=n>Trim</span><span class=p>().</span><span class=n>ToLowerInvariant</span><span class=p>();</span>
    <span class=n>NewsPost</span> <span class=n>result</span><span class=p>;</span>

    <span class=c1>// if not found in cache, grab metadata and create a new post entry
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(!</span><span class=k>this</span><span class=p>.</span><span class=n>_cache</span><span class=p>.</span><span class=n>TryGet</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=k>out</span> <span class=n>result</span><span class=p>))</span>
    <span class=p>{</span>
        <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>GetAllNewsAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(!</span><span class=k>this</span><span class=p>.</span><span class=n>_allPostsMetadata</span><span class=p>.</span><span class=n>TryGetValue</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=k>out</span> <span class=n>NewsPostMetadata</span> <span class=n>metadata</span><span class=p>))</span>
            <span class=k>return</span> <span class=k>null</span><span class=p>;</span>

        <span class=n>result</span> <span class=p>=</span> <span class=k>new</span> <span class=n>NewsPost</span><span class=p>(</span><span class=n>metadata</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(!</span><span class=n>metadata</span><span class=p>.</span><span class=n>ShowInEnvironment</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_environment</span><span class=p>))</span>
            <span class=k>return</span> <span class=k>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=c1>// parse markdown content
</span><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>includeContent</span> <span class=p>&amp;&amp;</span> <span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>HtmlContent</span><span class=p>))</span>
        <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>PopulateHtmlContentAsync</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>

    <span class=k>this</span><span class=p>.</span><span class=n>_cache</span><span class=p>.</span><span class=n>AddOrReplace</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>result</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>_options</span><span class=p>.</span><span class=n>CurrentValue</span><span class=p>.</span><span class=n>CacheLifetime</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>This is actually&mldr; really simple, eh? It&rsquo;s basically self explanatory - well, maybe with 1 little detail:<br><code>includeContent</code> allows this method to be called to get post without loading the content - effectively grabbing metadata only. This currently isn&rsquo;t used though - I could probably remove it.</p><p>Now, to the 2nd part of this - <code>PopulateHtmlContentAsync</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>private</span> <span class=k>async</span> <span class=n>Task</span> <span class=n>PopulateHtmlContentAsync</span><span class=p>(</span><span class=n>NewsPost</span> <span class=n>post</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>string</span> <span class=n>postData</span> <span class=p>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>LoadPostFileAsync</span><span class=p>(</span><span class=n>post</span><span class=p>.</span><span class=n>FilePath</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
    <span class=kt>string</span> <span class=n>contentRaw</span> <span class=p>=</span> <span class=n>postData</span><span class=p>.</span><span class=n>Substring</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>GetYamlEndIndex</span><span class=p>(</span><span class=n>postData</span><span class=p>,</span> <span class=n>post</span><span class=p>.</span><span class=n>FilePath</span><span class=p>)</span> <span class=p>+</span> <span class=n>yamlSeparator</span><span class=p>.</span><span class=n>Length</span><span class=p>).</span><span class=n>Trim</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>contentRaw</span><span class=p>))</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>InvalidDataException</span><span class=p>(</span><span class=s>$&#34;News post {post.FilePath} has no content&#34;</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>post</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>UseRazorEngine</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_log</span><span class=p>.</span><span class=n>LogTrace</span><span class=p>(</span><span class=s>&#34;Running Razor Engine on post {Path}&#34;</span><span class=p>,</span> <span class=n>post</span><span class=p>.</span><span class=n>FilePath</span><span class=p>);</span>
        <span class=n>contentRaw</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>_razor</span><span class=p>.</span><span class=n>Render</span><span class=p>(</span><span class=n>post</span><span class=p>.</span><span class=n>ID</span><span class=p>,</span> <span class=n>contentRaw</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>post</span><span class=p>.</span><span class=n>HtmlContent</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>_markdown</span><span class=p>.</span><span class=n>Parse</span><span class=p>(</span><span class=n>contentRaw</span><span class=p>);</span>
    <span class=n>post</span><span class=p>.</span><span class=n>MarkdownContent</span> <span class=p>=</span> <span class=n>contentRaw</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>This method reuses the <code>LoadPostFileAsync</code> method I have shown when we were <a href=#loading-files rel>loading files</a>. Then it skips all the YAML, as it&rsquo;s only interested in markdown body.</p><p>When all markdown is loaded, it optionally runs <a href=#razor rel>Razor Engine</a> on the content. After that, it finally uses <a href=#markdown rel>Markdown parser</a> and stores HTML output in post entry. As a bonus, it also stores markdown content.<br>Why? SnipLink API allows retrieving post as both HTML and Markdown.
Why? Because it can, why not?</p><h5 id=additional-methods>Additional Methods</h5><p>Well, we covered the core of News Provider. That&rsquo;s all the cool stuff it does to generate the posts.<br>But there are also 3 small bonus methods that are quite useful.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=kt>int</span><span class=p>&gt;</span> <span class=n>GetPagesCountAsync</span><span class=p>()</span>
<span class=p>{</span>
    <span class=n>NewsOptions</span> <span class=n>options</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>_options</span><span class=p>.</span><span class=n>CurrentValue</span><span class=p>;</span>
    <span class=kt>double</span> <span class=n>pageSize</span> <span class=p>=</span> <span class=n>options</span><span class=p>.</span><span class=n>PostPerPage</span><span class=p>;</span>
    <span class=kt>double</span> <span class=n>count</span> <span class=p>=</span> <span class=p>(</span><span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>GetAllNewsAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>)).</span><span class=n>Count</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>_environment</span><span class=p>.</span><span class=n>IsDevelopment</span><span class=p>())</span>
        <span class=n>count</span> <span class=p>*=</span> <span class=n>options</span><span class=p>.</span><span class=n>MultiplyPosts</span><span class=p>;</span>
    <span class=k>return</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>Math</span><span class=p>.</span><span class=n>Ceiling</span><span class=p>(</span><span class=n>count</span> <span class=p>/</span> <span class=n>pageSize</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>NewsPostMetadata</span><span class=p>&gt;&gt;</span> <span class=n>GetNewsPageAsync</span><span class=p>(</span><span class=kt>int</span> <span class=n>page</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>NewsOptions</span> <span class=n>options</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>_options</span><span class=p>.</span><span class=n>CurrentValue</span><span class=p>;</span>
    <span class=kt>uint</span> <span class=n>pageSize</span> <span class=p>=</span> <span class=n>options</span><span class=p>.</span><span class=n>PostPerPage</span><span class=p>;</span>
    <span class=kt>uint</span> <span class=n>skipCount</span> <span class=p>=</span> <span class=p>((</span><span class=kt>uint</span><span class=p>)</span><span class=n>page</span> <span class=p>-</span> <span class=m>1</span><span class=p>)</span> <span class=p>*</span> <span class=n>pageSize</span><span class=p>;</span>
    <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>NewsPostMetadata</span><span class=p>&gt;</span> <span class=n>results</span> <span class=p>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>GetAllNewsAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>results</span><span class=p>.</span><span class=n>OrderByDescending</span><span class=p>(</span><span class=n>metadata</span> <span class=p>=&gt;</span> <span class=n>metadata</span><span class=p>.</span><span class=n>Timestamp</span><span class=p>.</span><span class=n>Value</span><span class=p>)</span>
        <span class=p>.</span><span class=n>Skip</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>skipCount</span><span class=p>).</span><span class=n>Take</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>pageSize</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>NewsPostMetadata</span><span class=p>&gt;&gt;</span> <span class=n>GetAllNewsAsync</span><span class=p>()</span>
<span class=p>{</span>
    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>LoadAllPostsMetadataAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=n>_allPostsMetadata</span><span class=p>.</span><span class=n>Values</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>All of them are pretty simple, but each quite useful:</p><ul><li><code>GetPagesCountAsync</code> is used to build navigation on the posts list page.</li><li><code>GetNewsPageAsync</code> is used to get paginated entries to display on posts list page.</li><li><code>GetAllNewsAsync</code> is used to generate <em>sitemap.xml</em>.</li></ul><h3 id=displaying-posts>Displaying Posts</h3><p>Both <a href=https://beta.sniplink.net/news target=_blank rel="noopener noreffer">/news/</a> list page and <a href=https://beta.sniplink.net/news/release-v0.2.0 target=_blank rel="noopener noreffer">actual post</a> article page are simple Razor .cshtml pages. They contain more HTML than C# code - with some small exceptions (like generating navigation on posts list page), they merely iterate over and plug C# <code>NewsPost</code> and <code>NewsPostMetadata</code> variables into HTML. For this reason, I&rsquo;ll only cover the page models - but they&rsquo;re pretty simple too!</p><p><em>NewsList.cshtml.cs</em> (<code>@page "/news"</code>):<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>class</span> <span class=nc>NewsListModel</span> <span class=p>:</span> <span class=n>PageModel</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=k>readonly</span> <span class=n>INewsProvider</span> <span class=n>_newsProvider</span><span class=p>;</span>

    <span class=k>public</span> <span class=kt>int</span> <span class=n>CurrentPage</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>int</span> <span class=n>TotalPages</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>NewsPostMetadata</span><span class=p>&gt;</span> <span class=n>Posts</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

    <span class=k>public</span> <span class=n>NewsListModel</span><span class=p>(</span><span class=n>INewsProvider</span> <span class=n>newsProvider</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_newsProvider</span> <span class=p>=</span> <span class=n>newsProvider</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>IActionResult</span><span class=p>&gt;</span> <span class=n>OnGetAsync</span><span class=p>([</span><span class=n>FromQuery</span><span class=p>]</span><span class=kt>int</span> <span class=n>page</span> <span class=p>=</span> <span class=m>1</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>page</span> <span class=p>&lt;</span> <span class=m>1</span><span class=p>)</span>
            <span class=n>page</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>

        <span class=k>this</span><span class=p>.</span><span class=n>CurrentPage</span> <span class=p>=</span> <span class=n>page</span><span class=p>;</span>

        <span class=n>IEnumerable</span><span class=p>&lt;</span><span class=n>NewsPostMetadata</span><span class=p>&gt;</span> <span class=n>posts</span> <span class=p>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>_newsProvider</span><span class=p>.</span><span class=n>GetNewsPageAsync</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>CurrentPage</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>posts</span><span class=p>?.</span><span class=n>Any</span><span class=p>()</span> <span class=p>!=</span> <span class=k>true</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>NotFound</span><span class=p>();</span>

        <span class=k>this</span><span class=p>.</span><span class=n>Posts</span> <span class=p>=</span> <span class=n>posts</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=n>TotalPages</span> <span class=p>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>_newsProvider</span><span class=p>.</span><span class=n>GetPagesCountAsync</span><span class=p>().</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>CurrentPage</span> <span class=p>==</span> <span class=m>1</span><span class=p>)</span>
            <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>.</span><span class=n>SetTitle</span><span class=p>(</span><span class=s>&#34;News&#34;</span><span class=p>);</span>
        <span class=k>else</span>
            <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>.</span><span class=n>SetTitle</span><span class=p>(</span><span class=s>&#34;News Directory - Page &#34;</span> <span class=p>+</span> <span class=k>this</span><span class=p>.</span><span class=n>CurrentPage</span><span class=p>);</span>
        <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>[</span><span class=n>ViewDataKeys</span><span class=p>.</span><span class=n>AddNewsCSS</span><span class=p>]</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>
        <span class=k>return</span> <span class=n>Page</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></p><p><em>NewsEntry.cshtml.cs</em> (<code>@page "/news/{id}"</code>):<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>class</span> <span class=nc>NewsEntryModel</span> <span class=p>:</span> <span class=n>PageModel</span>
<span class=p>{</span>
    <span class=k>private</span> <span class=k>readonly</span> <span class=n>INewsProvider</span> <span class=n>_newsProvider</span><span class=p>;</span>

    <span class=k>public</span> <span class=n>NewsPost</span> <span class=n>CurrentPost</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>
    <span class=k>public</span> <span class=kt>uint</span> <span class=n>ReturnPageNumber</span> <span class=p>{</span> <span class=k>get</span><span class=p>;</span> <span class=k>private</span> <span class=k>set</span><span class=p>;</span> <span class=p>}</span>

    <span class=k>public</span> <span class=n>NewsEntryModel</span><span class=p>(</span><span class=n>INewsProvider</span> <span class=n>newsProvider</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=n>_newsProvider</span> <span class=p>=</span> <span class=n>newsProvider</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>async</span> <span class=n>Task</span><span class=p>&lt;</span><span class=n>IActionResult</span><span class=p>&gt;</span> <span class=n>OnGetAsync</span><span class=p>(</span><span class=kt>string</span> <span class=n>id</span><span class=p>,</span> <span class=kt>uint</span> <span class=n>returnPage</span> <span class=p>=</span> <span class=m>1</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>returnPage</span> <span class=p>&lt;</span> <span class=m>1</span><span class=p>)</span>
            <span class=n>returnPage</span> <span class=p>=</span> <span class=m>1</span><span class=p>;</span>

        <span class=k>if</span> <span class=p>(</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>id</span><span class=p>))</span>
            <span class=k>return</span> <span class=n>BadRequest</span><span class=p>();</span>

        <span class=n>NewsPost</span> <span class=n>post</span> <span class=p>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=n>_newsProvider</span><span class=p>.</span><span class=n>GetNewsPostAsync</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=k>true</span><span class=p>).</span><span class=n>ConfigureAwait</span><span class=p>(</span><span class=k>false</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>post</span> <span class=p>==</span> <span class=k>null</span><span class=p>)</span>
            <span class=k>return</span> <span class=n>NotFound</span><span class=p>();</span>

        <span class=k>this</span><span class=p>.</span><span class=n>CurrentPost</span> <span class=p>=</span> <span class=n>post</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=n>ReturnPageNumber</span> <span class=p>=</span> <span class=n>returnPage</span><span class=p>;</span>
        <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>.</span><span class=n>SetTitle</span><span class=p>(</span><span class=s>$&#34;News - {this.CurrentPost.Metadata.Title}&#34;</span><span class=p>);</span>
        <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>.</span><span class=n>SetDescription</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=n>CurrentPost</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>Description</span><span class=p>);</span>
        <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>[</span><span class=n>ViewDataKeys</span><span class=p>.</span><span class=n>AddNewsCSS</span><span class=p>]</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>

        <span class=c1>// for twitter cards (to use within Discord embeds etc)
</span><span class=c1></span>        <span class=kt>string</span> <span class=n>cardThumbnail</span> <span class=p>=</span> <span class=k>this</span><span class=p>.</span><span class=n>CurrentPost</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>ArticleThumbnailURL</span> <span class=p>??</span> <span class=k>this</span><span class=p>.</span><span class=n>CurrentPost</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>ListThumbnailURL</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(!</span><span class=kt>string</span><span class=p>.</span><span class=n>IsNullOrWhiteSpace</span><span class=p>(</span><span class=n>cardThumbnail</span><span class=p>))</span>
        <span class=p>{</span>
            <span class=k>if</span> <span class=p>(!</span><span class=n>cardThumbnail</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=sc>&#39;/&#39;</span><span class=p>)</span> <span class=p>&amp;&amp;</span> <span class=p>!</span><span class=n>cardThumbnail</span><span class=p>.</span><span class=n>StartsWith</span><span class=p>(</span><span class=s>&#34;http&#34;</span><span class=p>))</span>
                <span class=n>cardThumbnail</span> <span class=p>=</span> <span class=s>$&#34;/news/{this.CurrentPost.ID}/{cardThumbnail}&#34;</span><span class=p>;</span>
            <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>.</span><span class=n>SetThumbnailURL</span><span class=p>(</span><span class=n>cardThumbnail</span><span class=p>);</span> 
            <span class=k>base</span><span class=p>.</span><span class=n>ViewData</span><span class=p>.</span><span class=n>SetTwitterCardType</span><span class=p>(</span><span class=s>&#34;summary_large_image&#34;</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>return</span> <span class=n>Page</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></p><p>See? Told you they were easy.</p><p>The only thing worth noting are methods like <code>ViewData.SetTitle</code>. They&rsquo;re simple extensions I created to avoid using magic strings when accessing ViewData:<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-cs data-lang=cs><span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>ViewDataDictionaryExtensions</span>
<span class=p>{</span>
    <span class=c1>// TITLE
</span><span class=c1></span>    <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>SetTitle</span><span class=p>(</span><span class=k>this</span> <span class=n>ViewDataDictionary</span> <span class=n>viewData</span><span class=p>,</span> <span class=kt>string</span> <span class=k>value</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>viewData</span><span class=p>[</span><span class=n>ViewDataKeys</span><span class=p>.</span><span class=n>Title</span><span class=p>]</span> <span class=p>=</span> <span class=k>value</span><span class=p>;</span>
    <span class=k>public</span> <span class=k>static</span> <span class=kt>string</span> <span class=n>GetTitle</span><span class=p>(</span><span class=k>this</span> <span class=n>ViewDataDictionary</span> <span class=n>viewData</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>viewData</span><span class=p>[</span><span class=n>ViewDataKeys</span><span class=p>.</span><span class=n>Title</span><span class=p>]</span> <span class=k>as</span> <span class=kt>string</span><span class=p>;</span>
    <span class=k>public</span> <span class=k>static</span> <span class=kt>bool</span> <span class=n>TryGetTitle</span><span class=p>(</span><span class=k>this</span> <span class=n>ViewDataDictionary</span> <span class=n>viewData</span><span class=p>,</span> <span class=k>out</span> <span class=kt>string</span> <span class=k>value</span><span class=p>)</span>
        <span class=p>=&gt;</span> <span class=n>TryGetViewDataValue</span><span class=p>(</span><span class=n>viewData</span><span class=p>,</span> <span class=n>ViewDataKeys</span><span class=p>.</span><span class=n>Title</span><span class=p>,</span> <span class=k>out</span> <span class=k>value</span><span class=p>);</span>

    <span class=c1>// ... others ...
</span><span class=c1></span>
    <span class=k>private</span> <span class=k>static</span> <span class=kt>bool</span> <span class=n>TryGetViewDataValue</span><span class=p>&lt;</span><span class=n>T</span><span class=p>&gt;(</span><span class=n>ViewDataDictionary</span> <span class=n>viewData</span><span class=p>,</span> <span class=kt>string</span> <span class=n>key</span><span class=p>,</span> <span class=k>out</span> <span class=n>T</span> <span class=k>value</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>viewData</span><span class=p>.</span><span class=n>TryGetValue</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>out</span> <span class=kt>object</span> <span class=n>valueObj</span><span class=p>)</span> <span class=p>&amp;&amp;</span> <span class=n>valueObj</span> <span class=k>is</span> <span class=n>T</span> <span class=n>valueCasted</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=k>value</span> <span class=p>=</span> <span class=n>valueCasted</span><span class=p>;</span>
            <span class=k>return</span> <span class=k>true</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>value</span> <span class=p>=</span> <span class=k>default</span><span class=p>;</span>
        <span class=k>return</span> <span class=k>false</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=k>public</span> <span class=k>static</span> <span class=k>class</span> <span class=nc>ViewDataKeys</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>const</span> <span class=kt>string</span> <span class=n>Title</span> <span class=p>=</span> <span class=s>&#34;Title&#34;</span><span class=p>;</span>
    <span class=c1>// ... others ...
</span><span class=c1></span><span class=p>}</span>
</code></pre></td></tr></table></div></div></p><h2 id=what-else>What else?</h2><p>SnipLink also has API Endpoint which is nothing special - it merely calls the services I have shown above and wraps output in a model class (to not expose things might not want to expose) - nothing more, really. All hail SOLID and Dependency Injection!</p><p>Now a few notes - this solution is not perfect, and I am aware of that. There are a few issues.</p><p>Because it operates on markdown files, any change to post, even a typo fix, means redeployment of the application (or editing the file on the server). It&rsquo;s not that huge of a deal for me as I automated SnipLink deployment, however it still is not perfect.<br>Long term goal is to store the posts in database. However to do this any conveniently it requires some nice in-page editor with authentication system, or at least some ad-hoc uploader - because of that, I figured I&rsquo;ll go with files first.</p><p>Another problem is that in-memory caching could get RAM-heavy as news list grows. For this reason caching might need to be disabled later, and database approach would also help a bit here. But again - that&rsquo;s a problem for later. Current solution is easy enough to alter, so I am not worried at all.</p><p>One significant issue would be the security concerns of Razor Engine use for pages that allow user-submitted content. That said, it&rsquo;s not a problem for SnipLink - and if you want to use this blog as a guide, remember - <em>do</em> <em><strong>NOT</strong></em> <em>enable Razor Engine support if users can submit content</em>!</p><h2 id=summary>Summary</h2><p>As you can see, building news feature - which effectively is a blog engine! - wasn&rsquo;t actually hard, thanks to existing libraries.</p><p>What&rsquo;s really nice is that since I created this solution by myself, on top of quite customizable Markdown library, I can alter it to my needs as I go.</p><p>Do I plan to adapt this to this blog? Hell no. Hugo is designed for blogging and is amazing for it, and my blog is static, too - I stick with Hugo.<br>However for a dynamic server-based page like SnipLink that only needs news post - this solution is really good, and powerful enough to perfectly fit my needs.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 16.09.2021</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://tehgm.net/blog/sniplink-0.2.0-news/ data-title="Inside SnipLink v0.2.0 - News Page" data-via=TehOriginalGM data-hashtags=dev,web><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://tehgm.net/blog/sniplink-0.2.0-news/ data-hashtag=dev><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://tehgm.net/blog/sniplink-0.2.0-news/ data-title="Inside SnipLink v0.2.0 - News Page" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href=javascript:void(0); title="Share on Tumblr" data-sharer=tumblr data-url=https://tehgm.net/blog/sniplink-0.2.0-news/ data-title="Inside SnipLink v0.2.0 - News Page" data-caption="SnipLink v0.2.0 released with News page feature. Let's see how it looks under the hood!" data-tags=dev,web><i class="fab fa-tumblr fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://tehgm.net/blog/sniplink-0.2.0-news/ data-title="Inside SnipLink v0.2.0 - News Page"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://tehgm.net/blog/sniplink-0.2.0-news/><i class="fab fa-reddit fa-fw"></i></a><a href=javascript:void(0); title="Share on Myspace" data-sharer=myspace data-url=https://tehgm.net/blog/sniplink-0.2.0-news/ data-title="Inside SnipLink v0.2.0 - News Page" data-description="SnipLink v0.2.0 released with News page feature. Let's see how it looks under the hood!"><i data-svg-src=/lib/simple-icons/icons/myspace.min.svg></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/blog/tags/dev/>dev</a>,&nbsp;<a href=/blog/tags/web/>web</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/blog/stalker-anomaly-modpack/ class=prev rel=prev title="TehGM's Stalker Anomaly Modpack"><i class="fas fa-angle-left fa-fw"></i>TehGM's Stalker Anomaly Modpack</a>
<a href=/blog/docker-cheatsheet/ class=next rel=next title="TehGM's Docker Cheatsheet">TehGM's Docker Cheatsheet<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://tehgm.net>TehGM</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=https://code.jquery.com/jquery-3.5.1.min.js></script><script type=text/javascript src=/js/spoiler.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":60},"comment":{},"data":{"id-1":"TehGM","id-2":"TehGM"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"typeit":{"cursorChar":null,"cursorSpeed":null,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":null,"speed":null}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>